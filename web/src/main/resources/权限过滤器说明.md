# 权限过滤器架构说明（2024补充版）

## 概述

本网关系统采用分层权限过滤器架构，将不同类型的权限验证分离到独立的过滤器中，提高代码的可维护性和扩展性。每种权限类型有独立的过滤器，按优先级顺序依次执行，满足不同场景的安全需求。

## 过滤器架构

### 1. 抽象基类

- **AbstractPermissionFilter**  
  权限过滤器的基础抽象类，提供通用的权限检查、缓存、路径匹配等逻辑。所有具体权限过滤器均继承自该类。

### 2. 具体过滤器实现

#### WhiteListPermissionFilter（优先级: -200）
- **功能**：处理白名单路径，不需要任何认证
- **处理逻辑**：只要路径在白名单中，直接放行并跳过后续所有过滤器
- **配置**：通过 `PERMISSIONS_WHITE_LIST` 权限类型配置

#### AuthCodePermissionFilter（优先级: -190）
- **功能**：处理临时授权码（如分享码、一次性码等）校验
- **处理逻辑**：
    - 检查 URL 参数中是否有 `token`
    - 校验临时码的有效性、状态、过期时间、最大使用次数
    - 校验临时码允许的接口权限（`permissions` 字段）
    - 校验通过则直接放行，不再进入后续登录/角色权限过滤器
    - 校验失败则返回对应错误
- **配置**：通过 `PERMISSIONS_TEMP_LIST` 权限类型配置

#### CookiePermissionFilter（优先级: -180）
- **功能**：处理支持 Cookie token 的路径
- **处理逻辑**：从 Cookie 中提取 token 并添加到请求头，供后续过滤器使用
- **配置**：通过 `PERMISSIONS_COOKIE_LIST` 权限类型配置

#### LoginPermissionFilter（优先级: -150）
- **功能**：处理只需要登录验证的路径
- **处理逻辑**：验证 token 有效性，获取用户信息
- **配置**：通过 `PERMISSIONS_LOGIN_LIST` 权限类型配置

#### RolePermissionFilter（优先级: -100）
- **功能**：处理需要角色权限验证的路径
- **处理逻辑**：验证 token 有效性，检查用户角色权限
- **配置**：通过 `PERMISSIONS_AUTH_LIST` 权限类型配置

---

## 执行流程

```
请求进入
    ↓
WhiteListPermissionFilter (检查白名单)
    ↓ (如果在白名单中，直接放行)
AuthCodePermissionFilter (临时码校验)
    ↓ (临时码校验通过直接放行)
CookiePermissionFilter (处理Cookie token)
    ↓ (如果支持Cookie，提取token)
LoginPermissionFilter (检查登录权限)
    ↓ (如果需要登录验证，验证token)
RolePermissionFilter (检查角色权限)
    ↓ (如果需要角色权限，验证权限)
请求转发到后端服务
```

- 白名单路径直接放行
- 临时码校验通过直接放行
- 其他路径依次进入登录、角色权限校验

---

## 权限类型说明

- **PERMISSIONS_WHITE_LIST**：白名单权限，不需要任何认证
- **PERMISSIONS_TEMP_LIST**：临时授权码权限（如分享码、一次性码等）
- **PERMISSIONS_COOKIE_LIST**：支持 Cookie token 的权限
- **PERMISSIONS_LOGIN_LIST**：登录权限，只需验证用户已登录
- **PERMISSIONS_AUTH_LIST**：角色权限，需要验证用户具有特定的角色权限

---

## 配置示例

```json
{
  "PERMISSIONS_WHITE_LIST": [
    {"url": "/auth/captcha/**", "method": "GET"},
    {"url": "/auth/login/**", "method": "POST"}
  ],
  "PERMISSIONS_COOKIE_LIST": [
    {"url": "/public/share/**", "method": "*"}
  ],
  "PERMISSIONS_TEMP_LIST": [
    {"url": "/platform/api/share/**", "method": "*"}
  ],
  "PERMISSIONS_LOGIN_LIST": [
    {"url": "/api/user/profile/**", "method": "GET"}
  ],
  "PERMISSIONS_AUTH_LIST": [
    {"url": "/api/admin/**", "method": "*"}
  ]
}
```

---

## 过滤器优先级

| 过滤器                    | 优先级  | 说明                   |
|--------------------------|------|------------------------|
| WhiteListPermissionFilter | -200 | 白名单，最高优先级     |
| AuthCodePermissionFilter  | -190 | 临时授权码             |
| CookiePermissionFilter    | -180 | Cookie token           |
| LoginPermissionFilter     | -150 | 登录校验               |
| RolePermissionFilter      | -100 | 角色权限校验           |

---

## 迁移与扩展

- **扩展**：如需新增权限类型，继承 `AbstractPermissionFilter` 并注册到 Spring 容器即可

---

## 注意事项

1. **避免阻塞**：所有过滤器的 shouldSkip/shouldProcess 方法禁止调用阻塞的远程服务（如 Feign），只允许本地缓存/内存判断
2. **缓存机制**：权限数据建议预热到 Redis，避免高并发下频繁远程调用
3. **优先级顺序**：务必保证白名单、临时码等特殊场景优先于登录/角色校验
4. **错误处理**：统一使用工具类（如 UserAuthUtils）返回标准错误响应

---

如需进一步细化某个过滤器的说明或示例，请告知！ 